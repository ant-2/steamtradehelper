<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Steam trade helper</title>
  <script src="http://code.jquery.com/jquery-1.12.3.min.js"></script>
  <script src="js/common.js"></script>

  <style>
    table {
      border-collapse: collapse;
      margin-left: 1px;
      border-right: 1px solid black;
      border-bottom: 1px solid black;
    }

    td.nominal {
      text-align: right;
    }

    td, th {
      border-top: 1px solid black;
      border-left: 1px solid black;
      padding: 5px;
    }
  </style>
</head>

<body>
  <input id="in" type="text"/>
  <button id="btnSearch">Search</button>

  <table id="view">
    <thead id="header">
      <tr>
        <th>#</th>
        <th>Item name</th>
        <th>Genuine</th>
        <th>Vintage</th>
        <th>Unique</th>
        <th>Strange</th>
        <th>Haunted</th>
        <th>Collector's</th>
      </tr>
    </thead>

    <tbody>Body</tbody>
  </table>

  <script>
    var repoUrl = "rest/data/items";
    var view = $("tbody");
    var itemsArr;
    var qualitiesRowsIndexes = [1, 3, 6, 11, 13, 14]; // indexes of genuine, vintage, unique, strange, haunted, collector's

    renderResponse(getItems());

    function getItems() {
      if (itemsArr == undefined || itemsArr == null) {
        itemsArr = JSON.parse(getResource(repoUrl));
      }
      return itemsArr;
    }

    $("#btnSearch").click(function () {
      var strToSearch = $("#in").val();
      if (strToSearch.length > 0) {
        renderResponse(searchSubString(getItems(), strToSearch));
      }
    });

    function getResource(resourceUrl) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", resourceUrl, false);
      xhr.send();
      if (xhr.status != 200) {
        alert(xhr.status + ": " + xhr.statusText);
      } else {
        return xhr.responseText;
      }
    }

    function renderResponse(itemsArr) {
      view.empty();
      for (var n = 0; n < itemsArr.length; n++) {
        var item = itemsArr[n];

        var tableRow = view.append("<tr>");
        tableRow.append("<td class='nominal'>" + n + "</td>");
        tableRow.append("<td>" + item.name + "</td>");

        appendQualities(tableRow, item.qualities, qualitiesRowsIndexes);
      }
    }

    /*    function renderResponse(itemsArr) {
     view.empty();
     for (var n = 0; n < itemsArr.length; n++) {
     var item = itemsArr[n];

     var tableRow = view.append("<tr>");
     tableRow.append("<td class='nominal'>" + n + "</td>");
     tableRow.append("<td>" + item.name + "</td>");

     var qualities = "";
     for (var q = 0; q < item.qualities.length; q++) {
     qualities = (q != item.qualities.length - 1) ? qualities + item.qualities[q].quality + ", " : qualities + item.qualities[q].quality;
     }
     tableRow.append("<td>" + qualities + "</td>");
     tableRow.append("</tr>");
     }
     }*/

    function appendQualities(tr, qualities, rows) {
      var indexes = [];
      for (var i = 0; i < qualities.length; i++) {
        indexes.push(qualities[i].gameID);
      }

      for (var n = 0; n < rows.length; n++) {
        var positionInQualities = jQuery.inArray(rows[n], indexes);
        if (positionInQualities >= 0) {
          tr.append("<td>"+qualities[positionInQualities].quality+"</td>")
        } else {
          tr.append("<td></td>")
        }
      }
    }

    // ignores letter case
    function searchSubString(dataArray, string) {
      var matches = [];
      for (var i = 0; i < dataArray.length; i++) {
        if (~dataArray[i]
            .name.toLowerCase()
            .indexOf(string.toLowerCase())
        ) {
          matches.push(dataArray[i]);
        }
      }
      return matches;
    }
  </script>
</body>
</html>